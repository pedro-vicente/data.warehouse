#include <fstream>
#include <iostream>
#include <string>
#include <vector>
#include <assert.h>
#include <stdlib.h>
#include "csv.hh"

/////////////////////////////////////////////////////////////////////////////////////////////////////
//read_csv_t::read_csv_t
/////////////////////////////////////////////////////////////////////////////////////////////////////

read_csv_t::read_csv_t()
{
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
//read_csv_t::open
/////////////////////////////////////////////////////////////////////////////////////////////////////

int read_csv_t::open(const std::string& file_name)
{
  ifs.open(file_name.c_str());
  if (!ifs)
  {
    return -1;
  }
  return 0;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
//read_csv_t::close
/////////////////////////////////////////////////////////////////////////////////////////////////////

void read_csv_t::close()
{
  ifs.close();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
//read_csv_t::read_row_by_comma
/////////////////////////////////////////////////////////////////////////////////////////////////////

std::vector<std::string> read_csv_t::read_row_by_comma()
{
  bool quote_mode = false;
  std::vector<std::string> row;
  std::string column;
  char c;
  while (ifs.get(c))
  {
    switch (c)
    {
      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //separator ',' detected.
      //in quote mode add character to column
      //push column if not in quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    case ',':
      if (quote_mode == true)
      {
        column += c;
      }
      else
      {
        row.push_back(column);
        column.clear();
      }
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //quote '"' detected.
      //toggle quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    case '"':
      quote_mode = !quote_mode;
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //line end detected
      //in quote mode add character to column
      //return row if not in quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    case '\n':
    case '\r':
      if (quote_mode == true)
      {
        column += c;
      }
      else
      {
        //push last column
        row.push_back(column);
        return row;
      }
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //default, add character to column
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    default:
      column += c;
      break;
    }
  }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  //handle last row if file doesn't end with newline
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  if (!column.empty() || !row.empty())
  {
    row.push_back(column);
    ifs.close();
    return row;
  }

  //return empty vector if end of file detected
  ifs.close();
  std::vector<std::string> v;
  return v;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////
//read_csv_t::read_row_by_tab
/////////////////////////////////////////////////////////////////////////////////////////////////////

std::vector<std::string> read_csv_t::read_row_by_tab()
{
  bool quote_mode = false;
  std::vector<std::string> row;
  std::string column;
  char c;
  while (ifs.get(c))
  {
    switch (c)
    {
      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //separator '\t' detected.
      //in quote mode add character to column
      //push column if not in quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////


    case '\t':

      if (quote_mode == true)
      {
        column += c;
      }
      else
      {
        row.push_back(column);
        column.clear();
      }
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //quote '"' detected.
      //toggle quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    case '"':
      quote_mode = !quote_mode;
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //line end detected
      //in quote mode add character to column
      //return row if not in quote mode
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    case '\n':
    case '\r':
      if (quote_mode == true)
      {
        column += c;
      }
      else
      {
        //push last column
        row.push_back(column);
        return row;
      }
      break;

      /////////////////////////////////////////////////////////////////////////////////////////////////////
      //default, add character to column
      /////////////////////////////////////////////////////////////////////////////////////////////////////

    default:
      column += c;
      break;
    }
  }

  /////////////////////////////////////////////////////////////////////////////////////////////////////
  //handle last row if file doesn't end with newline
  /////////////////////////////////////////////////////////////////////////////////////////////////////

  if (!column.empty() || !row.empty())
  {
    row.push_back(column);
    ifs.close();
    return row;
  }

  //return empty vector if end of file detected
  ifs.close();
  std::vector<std::string> v;
  return v;
}
